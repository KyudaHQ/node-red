<script type="text/javascript">
  RED.nodes.registerType('kyuda-config', {
    category: 'config',
    defaults: {
      name: { value: '', required: true },
      organisationUid: { value: '', required: true }
    },
    credentials: {
      userId: { type: 'text' }
    },
    label: function () {
      return this.name;
    },
    oneditprepare: function () {
      var node = this;
      var pathname = document.location.pathname;
      if (pathname.slice(-1) != "/") {
        pathname += "/";
      }
      var callback = location.protocol + "//";
      callback += (location.port == "") ? location.hostname : location.hostname + ":" + location.port;
      callback += pathname + "kyuda/auth/callback";

      //////////////////////////////

      function pollKyudaCredentialsUrl() {
        $.getJSON(pathname + 'kyuda/credentials/' + node.id, function (data) {
          if (data.userId) {
            updateKyudaUserId(data.userId);
            delete window.kyudaConfigNodeIntervalId;
          } else {
            window.kyudaConfigNodeIntervalId = window.setTimeout(pollKyudaCredentialsUrl, 2000);
          }
        });
      }

      //////////////////////////////

      function getOrganisations() {
        $('#node-config-input-organisationUid').html('');
        $.getJSON(pathname + 'kyuda/credentials/' + node.id + '/organisations', function (data) {
          data.forEach(function (organisation) {
            if (node.organisationUid === organisation.uid) {
              $('#node-config-input-organisationUid').append(`<option value="${organisation.uid}" selected>${organisation.name} (${organisation.uid})</option>`);
            } else {
              $('#node-config-input-organisationUid').append(`<option value="${organisation.uid}">${organisation.name} (${organisation.uid})</option>`);
            }
          });
        });
      }

      //////////////////////////////

      function updateKyudaUserId(dn) {
        $("#node-config-kyuda-client-keys").hide();
        $("#node-config-kyuda").show();
        $("#node-config-kyuda-userId").html(dn);
      }

      $("#node-reset").mousedown(function () {
        $.getJSON(pathname + 'kyuda/credentials/' + node.id + '/organisations', function (data) {
          $("#node-config-kyuda-client-keys").show();
          $("#node-config-kyuda").hide();
        })
      })
      $("#node-reload").mousedown(function () {
        if (node && node.organisationUid) {
          getOrganisations();
        }
      })
      
      if (node.credentials.userId) {
        updateKyudaUserId(node.credentials.userId);
        getOrganisations();
      } else {
        $("#node-config-kyuda-client-keys").show();
        $("#node-config-kyuda").hide();
      }

      $("#node-config-start-auth").mousedown(function () {
        var url = 'kyuda/auth?id=' + node.id
          + '&callback=' + encodeURIComponent(callback)
        $(this).attr("href", url);
        window.kyudaConfigNodeIntervalId = window.setTimeout(pollKyudaCredentialsUrl, 2000);
      });

    }
  });
</script>

<script type="text/x-red" data-template-name="kyuda-config">
  <div class="form-row">
    <label for="node-config-input-name"><i class="icon-bookmark"></i> Name</label>
    <input type="text" id="node-config-input-name">
  </div>
  <div id="node-config-kyuda-client-keys">
    <div class="form-row input-startauth-row">
      <label>&nbsp;</label>
      <a class="btn" id="node-config-start-auth" href="#" target="_blank">Authenticate with Kyuda</a>
    </div>
  </div>
  <div id="node-config-kyuda">
    <div class="form-row">
        <label>User</label>
        <span id="node-config-kyuda-userId" class="uneditable-input" style="width: 70%;"></span>
    </div>
    <div class="form-row">
      <label for="node-config-input-organisationUid">Organisation</label>
      <select id="node-config-input-organisationUid" style="width: 70%;"></select>
    </div>
    <div class="form-row">
      <label>&nbsp;</label>
      <a class="btn" id="node-reload" href="#"">Reload</a>
    </div>
    <div class="form-row">
      <label>&nbsp;</label>
      <a class="btn" id="node-reset" href="#"">Reset</a>
    </div>
  </div>
</script>

<script type="text/x-red" data-help-name="kyuda-config" data-lang="en-US">

</script>